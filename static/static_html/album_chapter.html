<script>
    $(function () {
        $("#albumTable").jqGrid({
            url: "/album/getAllAlbum/",
            editurl: "",
            styleUI: "Bootstrap",
            datatype: "JSON",
            autowidth: true,
            height: 500,
            viewrecords: true,
            pager: "#albumPager",
            rowNum: 2,
            rowList: [5, 10, 15],
            rownumbers: true,
            multiselect: true,
            colNames: ["编号", "标题", "分数", "作者", "播音员", "章节数", "专辑简介", "状态", "发行时间", "上传时间", "插图"],
            colModel: [
                {name: "id", hidden: true},
                {
                    name: "title", editable: true,
                    editrules: {required: true}
                },
                {
                    name: "score", editable: true,
                    editrules: {required: true, number: true, minValue: 1, maxValue: 10}
                },
                {
                    name: "author", editable: true,
                    editrules: {required: true}
                },
                {
                    name: "broadcast", editable: true,
                    editrules: {required: true}
                },
                {
                    name: "count", editable: true,
                    editrules: {required: true, number: true, minValue: 1}
                },
                {
                    name: "brief", editable: true,
                    editrules: {required: true}
                },
                {
                    name: "status", editable: true, edittype: "select",
                    editoptions: {
                        value: "1:展示;2:不展示"
                    }
                },
                {
                    name: "publishDate", editable: true, edittype: "date",
                    editrules: {required: true}
                },
                {
                    name: "createDate", editable: true, edittype: "date",
                    editrules: {required: true}
                },
                {
                    name: "cover", editable: true, edittype: "file",
                    editoptions: {
                        enctype: "multipart/form-data"
                    },
                    formatter: function (cellvalue, options, rowObject) {
                        return "<img style='height: 80px;width: 180px' src='/static/upload/" + cellvalue + " '/>"
                    }
                },

            ],
            subGrid: true,          // 开启二级表格
            // 形参  是表格的id以及专辑的id
            subGridRowExpanded: function (subGridId, albumId) {
                addSubGrid(subGridId, albumId);     // 完成二级表格的生成
            }
        }).jqGrid("navGrid", "#albumPager", {
                add: true, edit: true, del: true, search: true, refresh: true, edittext: "编辑", addtext: "添加", deltext: "删除"
            },
        )
    });

    // 生成二级表格
    function addSubGrid(subGridId, albumId) {
        // 根据subGridId 定义对应子表格的table容器的id
        subGridTableId = subGridId + "table";
        // 根据subGridId 定义对应子表格的分页容器的id
        subGridPagerId = subGridId + "pager";
        // 生成容器
        $('#' + subGridId).html(
            "<table id='" + subGridTableId + "'></table><div id='" + subGridPagerId + "'></div>"
        );
        // 根据准备好的容器来生成二级表格
        $('#' + subGridTableId).jqGrid({
            // 查询章节时需要根据对应的专辑id进行查询
            url: "/album/getChapter/?albumId=" + albumId,
            datatype: "json",
            styleUI: "Bootstrap",
            autowidth: true,
            pager: "#" + subGridPagerId,
            viewrecords: true,
            caption: "章节管理",
            rowNum: 3,
            rowList: [3, 6, 10],
            multiselect: true,
            toolbar: [true, "top"],
            colNames: ["编号", "标题", "大小", "时长", "上传时间", "音频", "操作"],
            colModel: [
                {name: "id", align: "center"},
                {name: "title", align: "center"},
                {name: "size", align: "center"},
                {name: "duration", align: "center"},
                {name: "createDate", align: "center"},
                {
                    name: "url", align: "center", formatter: function (cellvalue, options, row) {
                        return "<a href=\"javascript:void(0)\" class=\"btn btn-primary\" onclick=\"playAudio('" + cellvalue + "')\"><span class=\"glyphicon glyphicon-play\"></span> 播放</a>";
                    }
                },
                {
                    name: "option", align: "center", formatter: function () {
                        // 在次数追加两个按钮  删除  与  修改
                        return '<a class="btn btn-primary" onclick="update()"> <span class="glyphicon glyphicon-edit"></span> 修改</a> ' +
                            '<a class="btn btn-danger" > <span class="glyphicon glyphicon-edit"></span> 删除</a> ';
                    }
                },
            ],

        });
        // 追加添加按钮
        $("#t_albumTable_0ee05392-7b76-11e9-bd6f-005056c00001table").append('<button class="btn btn-primary" onclick="showAddChapter()">添加章节</button>')
    }

    // 展示添加章节的模态框  完成章节信息的填写
    function showAddChapter() {
        // 调用展示模态框的方法  信息填写后保存
    }

    // 专辑的修改
    function update() {

    }

    // 播放的方法
    function playAudio(cellvalue) {
        $("#playAudioDiv").modal("show");
        $('#playAudioId').attr("src", "/static/audio/" + cellvalue)
    }

    // 自行完成下载（非必须）

</script>

<div class="page-header">
    <h2>专辑与章节管理</h2>
</div>
<ul class="nav nav-tabs">
    <li class="active" style="font-weight: bold"><a>专辑与章节信息</a></li>
</ul>
<!--播放音频所使用的div-->
<div id="playAudioDiv" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <audio id="playAudioId" src="" controls></audio>
    </div>
</div>

<div class="panel panel-default">
    <table id="albumTable"></table>
    <div id="albumPager" style="width: auto;height: 50px"></div>
</div>